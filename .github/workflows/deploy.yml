name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: â˜• JDK 17 ì„¤ì •
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ”¨ Gradle ë¹Œë“œ
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      - name: ğŸ“¦ JAR íŒŒì¼ í™•ì¸
        run: ls -lh build/libs/

      - name: ğŸ”‘ SSH Key ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ EC2 ë°°í¬
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            echo "========================================="
            echo "ğŸš€ EC2 ì„œë²„ ë°°í¬ ì‹œì‘"
            echo "========================================="
          
            PROJECT_DIR="/home/ubuntu/financeDream"
            JAR_NAME="demo-0.0.1-SNAPSHOT.jar"
          
            cd $PROJECT_DIR
          
            echo "ğŸ”„ Git Pull..."
            git pull origin main
          
            echo "ğŸ” ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ í™•ì¸..."
            CURRENT_PID=$(ps -ef | grep "$JAR_NAME" | grep -v grep | awk '{print $2}')
          
            if [ ! -z "$CURRENT_PID" ]; then
              echo "ğŸ›‘ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì¤‘... (PID: $CURRENT_PID)"
              kill -15 $CURRENT_PID
              sleep 5
          
              if ps -p $CURRENT_PID > /dev/null; then
                echo "âš ï¸  ê°•ì œ ì¢…ë£Œ..."
                kill -9 $CURRENT_PID
                sleep 2
              fi
            fi
          
            echo "ğŸ”¨ ë¹Œë“œ ì‹œì‘..."
            ./gradlew clean build -x test
          
            if [ $? -ne 0 ]; then
              echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
              exit 1
            fi
          
            echo "ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘..."
          
            DB_URL="jdbc:mysql://${{ secrets.MYSQL_HOST }}:${{ secrets.MYSQL_PORT }}/${{ secrets.MYSQL_DB }}?serverTimezone=Asia/Seoul&characterEncoding=UTF-8"
          
            nohup java -jar \
              -Dspring.datasource.url="${DB_URL}" \
              -Dspring.datasource.username="${{ secrets.MYSQL_USER }}" \
              -Dspring.datasource.password="${{ secrets.MYSQL_PASSWORD }}" \
              -Djwt.secret="${{ secrets.JWT_SECRET_KEY }}" \
              build/libs/$JAR_NAME > app.log 2>&1 &
          
            sleep 5
          
            NEW_PID=$(ps -ef | grep "$JAR_NAME" | grep -v grep | awk '{print $2}')
          
            if [ -z "$NEW_PID" ]; then
              echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹¤íŒ¨!"
              tail -30 app.log
              exit 1
            fi
          
            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì™„ë£Œ (PID: $NEW_PID)"
          
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬..."
            HEALTH_CHECK_PASSED=0
          
            for i in {1..20}; do
              sleep 5
          
              if ! ps -p $NEW_PID > /dev/null; then
                echo "âŒ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
                tail -50 app.log
                exit 1
              fi
          
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 2>/dev/null || echo "000")
          
              echo "[$i/20] HTTP Status: $HTTP_STATUS"
          
              if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 404 ] || [ "$HTTP_STATUS" -eq 401 ]; then
                echo "âœ… ë°°í¬ ì™„ë£Œ! (HTTP $HTTP_STATUS)"
                HEALTH_CHECK_PASSED=1
                break
              fi
            done
          
            if [ $HEALTH_CHECK_PASSED -eq 0 ]; then
              echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ íƒ€ì„ì•„ì›ƒ"
              tail -50 app.log
              exit 1
            fi
          
            exit 0
          ENDSSH

      - name: ğŸ§¹ SSH Key ì •ë¦¬
        if: always()
        run: rm -f ~/.ssh/id_rsa

      - name: ğŸ“¢ ë°°í¬ ê²°ê³¼
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          fi